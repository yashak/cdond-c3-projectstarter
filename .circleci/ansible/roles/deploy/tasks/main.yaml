---
- name: Create directory
  file:
    path: ~/backend
    state: directory

- name: "Copy backend build to server"
  become: yes
  unarchive:
    src:  ~/project/backend.tar.gz
    dest: /home/ubuntu/backend
    creates: /home/ubuntu/backend/dist/main.js
    owner: ubuntu

- name: "copy backend .env file"
  become: true
  copy:
    src: ~/project/backend/.env
    dest: /home/ubuntu/backend/.env

- name: Install
  become: true
  shell: 
    cd /home/ubuntu/backend
    npm install
    npm run build

- name: "Start backend with pm2"
  shell: |
    echo "Contents of the .env file (ansible task):"
    cat "~/project/backend/.env"
    #pm2 start /home/ubuntu/backend/dist/main.js
    #pm2 start npm --name backend -- start
    cd /home/ubuntu/backend
    pm2 stop default
    pm2 start npm -- start